<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Login System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #121212; color: #e0e0e0; }
        .form-container { background-color: #1e1e1e; border: 1px solid #333; }
        .form-input { background-color: #2b2b2b; border: 1px solid #555; }
        .form-button { background-color: #4CAF50; transition: all 0.3s; }
        .form-button:hover { background-color: #45a049; box-shadow: 0 0 15px rgba(76, 175, 80, 0.6); }
        .switch-link { color: #4CAF50; }
        .hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .welcome-check { width: 100px; height: 100px; border-radius: 50%; background: #4CAF50; display: flex; align-items: center; justify-content: center; margin: 2rem auto; }
        .welcome-check svg { width: 50px; height: 50px; color: white; }
        /* Password Strength Styles */
        #password-strength-meter { height: 5px; width: 0%; border-radius: 5px; transition: width 0.3s, background-color 0.3s; }
        .strength-weak { background-color: #f44336; width: 25%; }
        .strength-medium { background-color: #ff9800; width: 66%; }
        .strength-strong { background-color: #4CAF50; width: 100%; }
        .delete-btn { background-color: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; transition: background-color 0.2s; }
        .delete-btn:hover { background-color: #dc2626; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl p-8 space-y-8 rounded-lg form-container">
        
        <!-- Login View -->
        <div id="login-view">
            <h2 class="text-2xl font-bold text-center">Login to Your Account</h2>
            <form id="login-form" class="mt-8 space-y-6">
                <input type="text" id="login-username" placeholder="Username" required class="w-full px-4 py-2 rounded-md form-input">
                <div class="relative">
                    <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-2 pr-10 rounded-md form-input">
                    <button type="button" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-400 hover:text-gray-200 password-toggle">
                        <!-- SVG icon will be inserted here -->
                    </button>
                </div>
                <button type="submit" class="w-full py-2 font-semibold text-white rounded-md form-button">Login</button>
            </form>
            <p id="login-message" class="mt-2 text-center text-red-400"></p>
            <div class="flex justify-between mt-4 text-center">
                <a href="#" id="show-register-link" class="font-semibold switch-link">Register here</a>
                <a href="#" id="show-forgot-password-link" class="font-semibold text-gray-400 hover:text-gray-200">Forgot Password?</a>
            </div>
        </div>

        <!-- Register View -->
        <div id="register-view" class="hidden">
            <h2 class="text-2xl font-bold text-center">Create a New Account</h2>
            <form id="register-form" class="mt-8 space-y-6">
                <input type="text" id="register-username" placeholder="Username" required class="w-full px-4 py-2 rounded-md form-input">
                <div>
                    <div class="relative">
                        <input type="password" id="register-password" placeholder="Password" required class="w-full px-4 py-2 pr-10 rounded-md form-input">
                        <button type="button" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-400 hover:text-gray-200 password-toggle">
                            <!-- SVG icon will be inserted here -->
                        </button>
                    </div>
                    <div class="mt-2 bg-gray-700 rounded-full">
                        <div id="password-strength-meter"></div>
                    </div>
                    <p id="password-strength-text" class="mt-1 text-xs text-gray-400"></p>
                </div>
                <button type="submit" class="w-full py-2 font-semibold text-white rounded-md form-button">Register</button>
            </form>
            <p id="register-message" class="mt-2 text-center"></p>
            <p class="mt-4 text-center">Already have an account? <a href="#" class="font-semibold switch-link show-login-link">Login here</a></p>
        </div>

        <!-- Forgot Password View -->
        <div id="forgot-password-view" class="hidden">
            <h2 class="text-2xl font-bold text-center">Reset Your Password</h2>
            <form id="forgot-password-form" class="mt-8 space-y-6">
                <input type="text" id="forgot-username" placeholder="Enter your username" required class="w-full px-4 py-2 rounded-md form-input">
                <div class="relative">
                     <input type="password" id="forgot-new-password" placeholder="Enter new password" required class="w-full px-4 py-2 pr-10 rounded-md form-input">
                     <button type="button" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-400 hover:text-gray-200 password-toggle">
                        <!-- SVG icon will be inserted here -->
                    </button>
                </div>
                <button type="submit" class="w-full py-2 font-semibold text-white rounded-md form-button">Reset Password</button>
            </form>
            <p id="forgot-message" class="mt-2 text-center"></p>
            <p class="mt-4 text-center"><a href="#" class="font-semibold switch-link show-login-link">Back to Login</a></p>
        </div>

        <!-- Welcome View (for normal users) -->
        <div id="welcome-view" class="hidden text-center fade-in">
            <div class="welcome-check">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
            </div>
            <h2 class="text-3xl font-bold">Login Successful!</h2>
            <p id="welcome-message" class="mt-4 text-lg"></p>
            <button id="logout-button" class="w-full max-w-xs py-2 mx-auto mt-8 font-semibold text-white bg-red-600 rounded-md hover:bg-red-700">Logout</button>
        </div>
        
        <!-- Admin Dashboard View -->
        <div id="admin-dashboard-view" class="hidden">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold">Admin Dashboard</h2>
                <button id="admin-logout-button" class="px-4 py-2 font-semibold text-white bg-red-600 rounded-md hover:bg-red-700">Logout</button>
            </div>
            <div class="mt-6">
                <h3 class="text-lg font-semibold">User Session Activity</h3>
                <div id="session-table-container" class="mt-4 overflow-x-auto"></div>
            </div>
        </div>
    </div>

    <script>
        function decodeJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }
    
        document.addEventListener('DOMContentLoaded', () => {
            const views = { login: document.getElementById('login-view'), register: document.getElementById('register-view'), forgot: document.getElementById('forgot-password-view'), welcome: document.getElementById('welcome-view'), admin: document.getElementById('admin-dashboard-view') };
            const forms = { login: document.getElementById('login-form'), register: document.getElementById('register-form'), forgot: document.getElementById('forgot-password-form') };
            const messages = { login: document.getElementById('login-message'), register: document.getElementById('register-message'), forgot: document.getElementById('forgot-message'), welcome: document.getElementById('welcome-message') };
            const API_URL = 'https://login-system-7t50.onrender.com/';
            
            function showView(viewName) { Object.values(views).forEach(v => v.classList.add('hidden')); if(views[viewName]) views[viewName].classList.remove('hidden'); }
            
            setupPasswordToggles(); // Initialize password visibility toggles

            document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); showView('register'); });
            document.getElementById('show-forgot-password-link').addEventListener('click', (e) => { e.preventDefault(); showView('forgot'); });
            document.querySelectorAll('.show-login-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); showView('login'); }));

            const passwordInput = document.getElementById('register-password');
            const strengthMeter = document.getElementById('password-strength-meter');
            const strengthText = document.getElementById('password-strength-text');

            passwordInput.addEventListener('input', () => {
                const password = passwordInput.value;
                let score = 0;
                if (password.length >= 8) score++;
                if (/\d/.test(password)) score++;
                if (/[A-Z]/.test(password)) score++;
                if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) score++;
                strengthMeter.className = '';
                switch (score) {
                    case 1: case 2: strengthMeter.classList.add('strength-weak'); strengthText.textContent = 'Weak. Consider adding numbers, symbols, or uppercase letters.'; break;
                    case 3: strengthMeter.classList.add('strength-medium'); strengthText.textContent = 'Medium. Good, but could be stronger.'; break;
                    case 4: strengthMeter.classList.add('strength-strong'); strengthText.textContent = 'Strong password!'; break;
                    default: strengthText.textContent = '';
                }
            });
            
            function setupPasswordToggles() {
                const eyeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`;
                const eyeSlashIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>`;

                document.querySelectorAll('.password-toggle').forEach(button => {
                    const passwordInput = button.previousElementSibling;
                    button.innerHTML = eyeIcon;
                    button.addEventListener('click', () => {
                        const isPassword = passwordInput.type === 'password';
                        passwordInput.type = isPassword ? 'text' : 'password';
                        button.innerHTML = isPassword ? eyeSlashIcon : eyeIcon;
                    });
                });
            }

            forms.register.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('register-username').value;
                const password = document.getElementById('register-password').value;
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                messages.register.textContent = response.ok ? 'Registration successful! Please log in.' : `Error: ${data.error}`;
                messages.register.className = response.ok ? 'mt-2 text-center text-green-400' : 'mt-2 text-center text-red-400';
                if(response.ok) forms.register.reset();
            });

            forms.login.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    const decodedToken = decodeJwt(data.token);
                    if (decodedToken.role === 'admin') {
                        loadAdminDashboard();
                    } else {
                        messages.welcome.textContent = `Welcome, ${decodedToken.username}!`;
                        showView('welcome');
                    }
                } else { messages.login.textContent = `Error: ${data.error}`; }
            });

            function logout() {
                const token = localStorage.getItem('token');
                if (token) {
                    const decoded = decodeJwt(token);
                    if (decoded && decoded.session_id) {
                        fetch(`${API_URL}/logout`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ session_id: decoded.session_id })
                        });
                    }
                }
                localStorage.removeItem('token');
                forms.login.reset();
                messages.login.textContent = '';
                showView('login');
            }
            document.getElementById('logout-button').addEventListener('click', logout);
            document.getElementById('admin-logout-button').addEventListener('click', logout);
            
            forms.forgot.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('forgot-username').value;
                const new_password = document.getElementById('forgot-new-password').value;
                const response = await fetch(`${API_URL}/forgot-password`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, new_password })
                });
                const data = await response.json();
                messages.forgot.textContent = response.ok ? 'Password reset successfully! You can now log in.' : `Error: ${data.error}`;
                messages.forgot.className = response.ok ? 'mt-2 text-center text-green-400' : 'mt-2 text-center text-red-400';
                 if(response.ok) forms.forgot.reset();
            });

            async function loadAdminDashboard() {
                const token = localStorage.getItem('token');
                if (!token) { showView('login'); return; }
                const response = await fetch(`${API_URL}/admin/dashboard`, { headers: { 'x-access-token': token } });
                if (response.ok) {
                    const sessions = await response.json();
                    renderSessionTable(sessions);
                    showView('admin');
                } else { alert('Session expired or invalid.'); logout(); }
            }
            
            function renderSessionTable(sessions) {
                const container = document.getElementById('session-table-container');
                if (!sessions.length) { container.innerHTML = '<p>No session data available.</p>'; return; }
                const table = document.createElement('table');
                table.className = 'min-w-full bg-gray-800 rounded-lg';
                table.innerHTML = `<thead><tr>
                    <th class="px-4 py-2 text-left">Username</th>
                    <th class="px-4 py-2 text-left">Login Time (IST)</th>
                    <th class="px-4 py-2 text-left">Logout Time (IST)</th>
                    <th class="px-4 py-2 text-left">Action</th>
                </tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                sessions.forEach(s => {
                    const logoutTime = s.logout_time_ist === 'Active' ? `<span class="text-green-400">${s.logout_time_ist}</span>` : s.logout_time_ist;
                    const row = document.createElement('tr');
                    row.className = 'border-t border-gray-700';
                    row.innerHTML = `
                        <td class="px-4 py-2">${s.username}</td>
                        <td class="px-4 py-2">${s.login_time_ist}</td>
                        <td class="px-4 py-2">${logoutTime}</td>
                        <td class="px-4 py-2"><button class="delete-btn" data-session-id="${s._id}">Delete</button></td>`;
                    tbody.appendChild(row);
                });
                container.innerHTML = '';
                container.appendChild(table);
            }

            document.getElementById('session-table-container').addEventListener('click', async (e) => {
                if (e.target && e.target.classList.contains('delete-btn')) {
                    const sessionId = e.target.dataset.sessionId;
                    if (confirm('Are you sure you want to delete this session record?')) {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`${API_URL}/admin/session/${sessionId}`, {
                            method: 'DELETE',
                            headers: { 'x-access-token': token }
                        });
                        if (response.ok) {
                            alert('Session deleted successfully.');
                            loadAdminDashboard();
                        } else {
                            const data = await response.json();
                            alert(`Error: ${data.error}`);
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>


